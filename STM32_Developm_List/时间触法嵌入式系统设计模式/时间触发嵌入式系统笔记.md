# 时间触发嵌入式系统设计模式

- [时间触发嵌入式系统设计模式](#时间触发嵌入式系统设计模式)
  - [硬件基础](#硬件基础)
    - [实时系统和非实时系统  P6（实时系统）](#实时系统和非实时系统--p6实时系统)
    - [软件设计  P15](#软件设计--p15)
    - [阻容复位  P56](#阻容复位--p56)
    - [直接寻址和间接寻址  P67](#直接寻址和间接寻址--p67)
    - [DATA、BDATA、IDATA  P70](#databdataidata--p70)
    - [单片机驱动一个LED灯的电阻选择  P90](#单片机驱动一个led灯的电阻选择--p90)
    - [BJT 晶体管 NPN、PNP  P101](#bjt-晶体管-npnpnp--p101)
      - [PNP驱动方式 P102](#pnp驱动方式-p102)
      - [保护三极管免受冲击  P106](#保护三极管免受冲击--p106)
      - [MOS 管  P113](#mos-管--p113)
        - [MOS 管直流电机驱动 P117](#mos-管直流电机驱动-p117)
    - [电磁继电器  P122](#电磁继电器--p122)
      - [EMI 电磁干扰  P123](#emi-电磁干扰--p123)
  - [软件基础](#软件基础)
    - [使用端口](#使用端口)
      - [项目头文件的例子  P139](#项目头文件的例子--p139)
      - [读写位  P149](#读写位--p149)
      - [端口头文件  P151](#端口头文件--p151)
      - [功能 C 文件  P165](#功能-c-文件--p165)
    - [延迟  P158](#延迟--p158)
      - [硬件延时适合 ms 级别的，软件延时适合 us 级别的  P158](#硬件延时适合-ms-级别的软件延时适合-us-级别的--p158)
  - [单处理器系统的时间触发结构  P187](#单处理器系统的时间触发结构--p187)
    - [调度器的介绍  P187](#调度器的介绍--p187)
      - [许多嵌入式系统执行的任务，可以分为两种  P190](#许多嵌入式系统执行的任务可以分为两种--p190)
      - [如何在一个 C 文件中调用内部函数写法  P194](#如何在一个-c-文件中调用内部函数写法--p194)
      - [什么是调度器  P198](#什么是调度器--p198)
      - [调度器性能比较  P199](#调度器性能比较--p199)
      - [合作式调度器 - 函数指针的演示  P207](#合作式调度器---函数指针的演示--p207)
      - [调度器数据结构以及任务队列  P211](#调度器数据结构以及任务队列--p211)
      - [合作调度器 “每个微控制器一个中断”的原则  P213](#合作调度器-每个微控制器一个中断的原则--p213)
      - [调度器的一些函数  P214](#调度器的一些函数--p214)
      - [调度应用程序，重要特性是支持低功耗运行  P220](#调度应用程序重要特性是支持低功耗运行--p220)
      - [错误报告  P220](#错误报告--p220)
      - [处理任务重叠  P225](#处理任务重叠--p225)
      - [如何确保调度器可预测，可靠的准则  P226](#如何确保调度器可预测可靠的准则--p226)
      - [合作式调度器的缺点  P227](#合作式调度器的缺点--p227)
      - [合作式调度器内核程序库  P228](#合作式调度器内核程序库--p228)
      - [循环超时和应将超时  P249](#循环超时和应将超时--p249)
      - [面向任务的设计  P255](#面向任务的设计--p255)
      - [多级任务例子  P257](#多级任务例子--p257)
      - [多状态任务  P261](#多状态任务--p261)

## 硬件基础

### 实时系统和非实时系统  P6（实时系统）

> 实时系统： 必须在某个固定时间（4ms，6ms）内执行，并完成某个任务； 比如，飞机，导弹引爆等
> 非实时系统： 手机，电脑，可以快一点，但慢一点也行的

### 软件设计  P15

> 数据流图
> 状态转移图

### 阻容复位  P56

|                                                   |                                                        |
| ------------------------------------------------- | ------------------------------------------------------ |
| ![img](./img/2022-05-11_095817_RC_reset_High.jpg) | ![img](./img/2022-05-11_095913_RC_reset_High_wave.jpg) |
| ![img](./img/2022-05-11_100025_min_system.jpg)    | ![img](./img/2022-05-11_100114_RC_reset_Low.jpg)       |

- 10uF + 100k, 复位时间是 100ms
- 10uF + 10k, 复位时间是 83ms

### 直接寻址和间接寻址  P67

![img](./img/2022-05-11_100710_address.jpg)

### DATA、BDATA、IDATA  P70

- 将程序存储在 ROM 中： int code a[256] = {0x0000, 0x0001, 0x0002 ...}
- 使用 DATA 区: char data a;
- 使用 BDATA 区: char idata b;
- 使用 IDATA 区: char bdata c;

### 单片机驱动一个LED灯的电阻选择  P90

- MCU 一般只能用来控制，所有电器消耗的电能均需要来自 VCC

![img](./img/2022-05-11_103919_led_res.jpg)

### BJT 晶体管 NPN、PNP  P101

- NPN 是基极提供电流
- PNP 是基极吸收电流
- hfe 是三级管的放大倍数

![img](./img/2022-05-11_110339_NPN_PNP.jpg)

#### PNP驱动方式 P102

- PNP 驱动方式：b = 0; 有电流流出，三极管导通；b = 1；没有电流流出，三极管截止

|                                              |                                              |
| -------------------------------------------- | -------------------------------------------- |
| ![img](./img/2022-05-11_110710_pnp_work.jpg) | ![img](./img/2022-05-11_110910_pnp_curi.jpg) |

#### 保护三极管免受冲击  P106

![img](./img/2022-05-11_111652_protect.jpg)

#### MOS 管  P113

- 三极管是双极型晶体管，有两个PN节，是电流控制开关
- MOS管是半导体场效应管，是电压控制开关，开关频率很快，常用在PWM控制中，对静电非常敏感

![img](./img/2022-05-11_112548_MOS.jpg)

##### MOS 管直流电机驱动 P117

![img](./img/2022-05-11_112823_MOS_Motor.jpg)

### 电磁继电器  P122

![img](./img/2022-05-11_113741_Relay.jpg)

#### EMI 电磁干扰  P123

- 过零检测

![img](./img/2022-05-11_114019_Zero_Cross.jpg)

## 软件基础

### 使用端口

#### 项目头文件的例子  P139

- 以后编程需要养成某种编程风格，可以参考：
- main.h

![img](./img/2022-05-12_114545_heard_H.jpg)
![img](./img/2022-05-12_114708_h_1.jpg)

#### 读写位  P149

- 位的读写，可以参考
- 现在对位的读写，使用的宏定义的方式，比使用函数更优

|                                             |                                             |
| ------------------------------------------- | ------------------------------------------- |
| ![img](./img/2022-05-12_135815_Bit_R_W.png) | ![img](./img/2022-05-12_140026_Bit_Now.jpg) |

#### 端口头文件  P151

- 端口头文件： 用来定义端口和端口初始化
- Port.h

![img](./img/2022-05-12_141127_Port_H.jpg)
![img](./img/2022-05-12_141206_Port_H_1.jpg)

#### 功能 C 文件  P165

- .c 文件的格式，可以参考

![img](./img/2022-05-12_144106_C_file.jpg)
![img](./img/2022-05-12_144201_C_file_1.jpg)
![img](./img/2022-05-12_144249_C_file_2.jpg)

### 延迟  P158

#### 硬件延时适合 ms 级别的，软件延时适合 us 级别的  P158

![img](./img/2022-05-12_145711_Delay.jpg)

## 单处理器系统的时间触发结构  P187

### 调度器的介绍  P187

#### 许多嵌入式系统执行的任务，可以分为两种  P190

- 周期性任务， 比方说：每 100ms 执行一次
- 单次任务， 比方说：在 50ms 的延迟之后执行一次

![img](./img/2022-05-12_160541_Task_sort.jpg)

#### 如何在一个 C 文件中调用内部函数写法  P194

![img](./img/2022-05-13_101614_C_function.jpg)

#### 什么是调度器  P198

- Scheduler 调度器
- 调度器可以看作一个简单的操作系统

![img](./img/2022-05-13_103659_Schedule.jpg)

#### 调度器性能比较  P199

- 合作式调度： 单任务系统结构，简单，可靠，代码量少，不是独立系统，是开发的一部分
- 抢占式调度： 多任务系统结构，复杂，响应快，不可预测，单独作为一个独立系统，
- 混合式调度： 支持有限个（1个）抢占式任务，可靠，不是独立系统，是开发的一部分
- 总结： 大多数的嵌入式开发系统，都可以使用合作式调度

#### 合作式调度器 - 函数指针的演示  P207

- 使用 STM32F1 或 STM32F4 练习

TODO: 理解函数指针 和 函数如何传参数以及回传

使用 STM32F103C8 芯片练习函数指针

- 函数指针在桌面应用很少用到，但却是创建调度器的关键

#### 调度器数据结构以及任务队列  P211

- 理解结构体，和队列

TODO: 复制出来合作调度器的相关结构体等

使用 STM32F103C8 芯片练习函数指针

- 调度器的核心是调度器数据结构；是用户自定义的数据类型
- 初始化；设定 “时标” 1ms

#### 合作调度器 “每个微控制器一个中断”的原则  P213

- TODO: 只能用一个中断，那其他中断怎么办？

后面应该会有提示，不可能只能用一个中断

#### 调度器的一些函数  P214

TODO: 需要用 stm32 运行的

- “刷新”函数
- “添加任务”函数
- “调度”程序函数
- “开始”函数
- “删除任务”函数
- “睡眠”函数
- “错误报告”函数
- “看门狗”

#### 调度应用程序，重要特性是支持低功耗运行  P220

#### 错误报告  P220

- 记录系统中的错误，以 LED 或者更加友好的 LCD 界面显示出来，用来通知用户发现错误

#### 处理任务重叠  P225

- 合理使用任务初始延迟
- 大多数情况下，1ms 的时标是通用的
- 如果想把开销和功耗降低，可以加长调度器时标
- 多个任务，使用 ”最大公因数“ 作为时标

#### 如何确保调度器可预测，可靠的准则  P226

- 时标间隔 = 最大公因数
- 所有任务运行时间都应小于调度时标间隔。往往用软件模拟测量任务运行时间
- 所有任务设置“超时”，使他们不会阻塞调度器；printf 就没有超时特性
- 减少任务重叠，合理使用任务初始延时；如果任务短，不会超时，或可以容忍任务抖动，可以不关心任务重叠

#### 合作式调度器的缺点  P227

- 如何保证快速响应外部事件
- 任务使用多个中断不安全，只能有一个定时中断，其他中断怎么处理？

#### 合作式调度器内核程序库  P228

- 需要抄出来运行一下

#### 循环超时和应将超时  P249

- 循环超时就是一个 while 循环判断时间；
- 硬件超时就是配置一个硬件定时器，计数更准确

#### 面向任务的设计  P255

- 多级任务： 将长任务转换为短任务
- 多状态任务： 将多个任务替换为一个任务，根据系统的当前状态执行不同的操作

![img](./img/2022-05-17_083517_Task.jpg)

#### 多级任务例子  P257

- 使用UART每隔5s发送43个字符的长任务分割

![img](./img/2022-05-17_085838_UART.png)

- 使用定时器外部计数，进行脉冲计数

![img](./img/2022-05-17_093755_Timer_Count.jpg)

#### 多状态任务  P261

- 洗衣机系统中，系统刷新任务

- 多状态任务实现交通灯控制系统  P266

